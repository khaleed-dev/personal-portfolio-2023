// libraries
const fs = require("fs")
const path = require("path")
const express = require("express")
const router = express.Router()
const axios = require("axios")

// variables
const github_access_token = "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"

router.get("/github", async (req, res) => {
    try {
        const headers = {
            headers: {
                Authorization: "Token " + github_access_token,
            },
        }
        // Send a GET request to the GitHub API
        const repos = await axios.get(
            "https://api.github.com/user/repos",
            headers
        )

        // get the languages of each repo
        const reposWithLanguages = await Promise.all(
            repos.data.map(async (repo) => {
                const languages = await axios.get(repo.languages_url, headers)
                repo.languages = languages.data
                return repo
            })
        )
        // Sort repos by created_at in descending order
        reposWithLanguages.sort((a, b) => {
            return new Date(b.created_at) - new Date(a.created_at)
        })
        res.json(reposWithLanguages)
    } catch (error) {
        res.status(500).send({error})
    }
})

router.get("/projects", async (req, res) => {
    try {
        // use projects.json to get the projects
        const projectsFile = await fs.promises.readFile('../projects.json', 'utf-8');
        const projects = JSON.parse(projectsFile);
        res.json(projects)
    } catch (error) {
        res.status(500).send({error})
    }
})

router.get("/images/:imgName", async (req, res) => {
    try {
        const imageName = req.params.imgName
        const imagePath = path.join(__dirname, `../images/${imageName}.png`)
        res.sendFile(imagePath)
    } catch (error) {
        res.status(500).send({error})
    }
})

module.exports = router
